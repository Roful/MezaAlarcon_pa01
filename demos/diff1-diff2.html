<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=utf-8">
<LINK href="diff.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="nav.js"></script>
</head>
<body>
<div id="left" class="src">
<pre>
<a id='leftstart' tid='rightstart'></a>
<span class='d'>;; yDiff - a language-aware tool for comparing programs
</span><a id='1901' tid='1902' class='u'>;; Copyright (C) 2011 Yin Wang (yinwang0@gmail.com)
</a>

<a id='1903' tid='1904' class='u'>;; This program is free software: you can redistribute it and/or modify
</a><a id='1905' tid='1906' class='u'>;; it under the terms of the GNU General Public License as published by
</a><a id='1907' tid='1908' class='u'>;; the Free Software Foundation, either version 3 of the License, or
</a><a id='1909' tid='1910' class='u'>;; (at your option) any later version.
</a>
<a id='1911' tid='1912' class='u'>;; This program is distributed in the hope that it will be useful,
</a><a id='1913' tid='1914' class='u'>;; but WITHOUT ANY WARRANTY; without even the implied warranty of
</a><a id='1915' tid='1916' class='u'>;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</a><a id='1917' tid='1918' class='u'>;; GNU General Public License for more details.
</a>
<a id='1919' tid='1920' class='u'>;; You should have received a copy of the GNU General Public License
</a><a id='1921' tid='1922' class='u'>;; along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
</a>


<span class='d'>(load &quot;utils.ss&quot;)</span>



<span class='d'>;-------------------------------------------------------------
</span><span class='d'>;                      parameters
</span><span class='d'>;-------------------------------------------------------------
</span>
<span class='d'>;; The ratio of cost/size that we consider two nodes to be
</span><span class='d'>;; &quot;similar&quot;, so as to perform a heuristic move (that will
</span><span class='d'>;; cut running time by a lot.) But this number should be
</span><span class='d'>;; small enough otherwise everything will be considered to
</span><span class='d'>;; be moves! Set to a small number for accuracy.
</span><span class='d'>(define *move-ratio* 0)</span>


<span class='d'>;; The minimum size of a node to be considered for moves.
</span><span class='d'>;; Shouldn&#39;t be too small, otherwise small deletec names
</span><span class='d'>;; will appear in a very distant place! This number should
</span><span class='d'>;; be larger than *min-frame-size* otherwise it will not be
</span><span class='d'>;; effective because substructural diff will do it.
</span>(<a id='809' tid='810' class='u'>define</a> <a id='811' tid='812' class='u'>*move-size*</a> <a id='813' tid='814' class='u'>5</a>)


<span class='d'>;; The depth limit for detecting substructural moves. If
</span><span class='d'>;; this is set, we will ignore nodes that are deeper than
</span><span class='d'>;; this number. The minimum is 7 to be useful.
</span><span class='d'>(define *move-depth* 5)</span>

<span class='d'>;; How many iterations do we go for moves? This parameter
</span><span class='d'>;; should be large enough so that we can discover enough
</span><span class='d'>;; moves. The algorithm is guaranteed to terminate, but it
</span><span class='d'>;; should be be set to some small number if we found that it
</span><span class='d'>;; takes too much time to terminate. This value should be
</span><span class='d'>;; larger than 7 in order to work for normal programs.
</span><span class='d'>(define *move-iteration* 1000)</span>


<span class='d'>;; How large must a node be considered as container for
</span><span class='d'>;; another node? If this is set to a big number, we will
</span><span class='d'>;; ignore nodes that are smaller than the number. This
</span><span class='d'>;; number shouldn&#39;t be too small, otherwise too many
</span><span class='d'>;; spurious moves will be detected! For example, a deleted
</span><span class='d'>;; &quot;int&quot; could be moved to a very far place! Setting it to a
</span><span class='d'>;; bigger number also reduces running time (by a great
</span><span class='d'>;; amount) because less substructural moves are considered.
</span><span class='d'>;; Set it to a larger number will cause loss of
</span><span class='d'>;; substructural changes, but greatly reduces time to run.
</span><span class='d'>(define *min-frame-size* 3)</span>


<span class='d'>;; How deep must the frames be for us to consider them as
</span><span class='d'>;; moves? This affects only already extracted frames, which
</span><span class='d'>;; may be considered to be moves to other extracted frames.
</span><span class='d'>;; Set it large will not necessarily lower accuracy, but
</span><span class='d'>;; improves performance.
</span><span class='d'>(define *min-frame-depth* 2)</span>


<span class='d'>;; How long must a string be in order for us to use
</span><span class='d'>;; string-dist function, which is costly when used on long
</span><span class='d'>;; strings but the most accurate method to use. This
</span><span class='d'>;; parameter affects strings/comments only. We use
</span><span class='d'>;; string-dist for all Tokens.
</span>(<a id='799' tid='800' class='u'>define</a> <a id='801' tid='802' class='u'>*max-string-len*</a> <span class='d'>200</span>)


<span class='d'>;; only memoize the diff of nodes of size larger than this
</span><span class='d'>;; number
</span>(<a id='803' tid='804' class='u'>define</a> <a id='805' tid='806' class='u'>*memo-node-size*</a> <a id='807' tid='808' class='u'>2</a>)



<span class='d'>(define *keywords* &#39;())</span>
<span class='d'>(define *keyword-exchange* &#39;())</span>
<span class='d'>(define *defs* &#39;())</span>



<span class='d'>;-------------------------------------------------------------
</span><span class='d'>;                      utilities
</span><span class='d'>;-------------------------------------------------------------
</span>
(<a id='1551' tid='1552' class='u'>define</a> <a id='1553' tid='1554' class='u'>qs</a>
  <span class='d'>(lambda (x)
    (string-append &quot;&#39;&quot; (number-&gt;string x) &quot;&#39;&quot;))</span>)


(<a id='1403' tid='1404' class='u'>define</a> <a id='1405' tid='1406' class='u'>line</a>
  (<a id='1407' tid='1408' class='u'>lambda</a> (<a id='1409' tid='1410' class='u'>port</a> <a id='1411' tid='1412' class='u'>.</a> <a id='1413' tid='1414' class='u'>s</a>)
    (<a id='1415' tid='1416' class=