<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=utf-8">
<LINK href="diff.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="nav.js"></script>
</head>
<body>
<div id="left" class="src">
<pre>
<a id='leftstart' tid='rightstart'></a>
<span class='d'>;; yDiff - a language-aware tool for comparing programs
</span><a id='1901' tid='1902' class='u'>;; Copyright (C) 2011 Yin Wang (yinwang0@gmail.com)
</a>

<a id='1903' tid='1904' class='u'>;; This program is free software: you can redistribute it and/or modify
</a><a id='1905' tid='1906' class='u'>;; it under the terms of the GNU General Public License as published by
</a><a id='1907' tid='1908' class='u'>;; the Free Software Foundation, either version 3 of the License, or
</a><a id='1909' tid='1910' class='u'>;; (at your option) any later version.
</a>
<a id='1911' tid='1912' class='u'>;; This program is distributed in the hope that it will be useful,
</a><a id='1913' tid='1914' class='u'>;; but WITHOUT ANY WARRANTY; without even the implied warranty of
</a><a id='1915' tid='1916' class='u'>;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</a><a id='1917' tid='1918' class='u'>;; GNU General Public License for more details.
</a>
<a id='1919' tid='1920' class='u'>;; You should have received a copy of the GNU General Public License
</a><a id='1921' tid='1922' class='u'>;; along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
</a>


<span class='d'>(load &quot;utils.ss&quot;)</span>



<span class='d'>;-------------------------------------------------------------
</span><span class='d'>;                      parameters
</span><span class='d'>;-------------------------------------------------------------
</span>
<span class='d'>;; The ratio of cost/size that we consider two nodes to be
</span><span class='d'>;; &quot;similar&quot;, so as to perform a heuristic move (that will
</span><span class='d'>;; cut running time by a lot.) But this number should be
</span><span class='d'>;; small enough otherwise everything will be considered to
</span><span class='d'>;; be moves! Set to a small number for accuracy.
</span><span class='d'>(define *move-ratio* 0)</span>


<span class='d'>;; The minimum size of a node to be considered for moves.
</span><span class='d'>;; Shouldn&#39;t be too small, otherwise small deletec names
</span><span class='d'>;; will appear in a very distant place! This number should
</span><span class='d'>;; be larger than *min-frame-size* otherwise it will not be
</span><span class='d'>;; effective because substructural diff will do it.
</span>(<a id='809' tid='810' class='u'>define</a> <a id='811' tid='812' class='u'>*move-size*</a> <a id='813' tid='814' class='u'>5</a>)


<span class='d'>;; The depth limit for detecting substructural moves. If
</span><span class='d'>;; this is set, we will ignore nodes that are deeper than
</span><span class='d'>;; this number. The minimum is 7 to be useful.
</span><span class='d'>(define *move-depth* 5)</span>

<span class='d'>;; How many iterations do we go for moves? This parameter
</span><span class='d'>;; should be large enough so that we can discover enough
</span><span class='d'>;; moves. The algorithm is guaranteed to terminate, but it
</span><span class='d'>;; should be be set to some small number if we found that it
</span><span class='d'>;; takes too much time to terminate. This value should be
</span><span class='d'>;; larger than 7 in order to work for normal programs.
</span><span class='d'>(define *move-iteration* 1000)</span>


<span class='d'>;; How large must a node be considered as container for
</span><span class='d'>;; another node? If this is set to a big number, we will
</span><span class='d'>;; ignore nodes that are smaller than the number. This
</span><span class='d'>;; number shouldn&#39;t be too small, otherwise too many
</span><span class='d'>;; spurious moves will be detected! For example, a deleted
</span><span class='d'>;; &quot;int&quot; could be moved to a very far place! Setting it to a
</span><span class='d'>;; bigger number also reduces running time (by a great
</span><span class='d'>;; amount) because less substructural moves are considered.
</span><span class='d'>;; Set it to a larger number will cause loss of
</span><span class='d'>;; substructural changes, but greatly reduces time to run.
</span><span class='d'>(define *min-frame-size* 3)</span>


<span class='d'>;; How deep must the frames be for us to consider them as
</span><span class='d'>;; moves? This affects only already extracted frames, which
</span><span class='d'>;; may be considered to be moves to other extracted frames.
</span><span class='d'>;; Set it large will not necessarily lower accuracy, but
</span><span class='d'>;; improves performance.
</span><span class='d'>(define *min-frame-depth* 2)</span>


<span class='d'>;; How long must a string be in order for us to use
</span><span class='d'>;; string-dist function, which is costly when used on long
</span><span class='d'>;; strings but the most accurate method to use. This
</span><span class='d'>;; parameter affects strings/comments only. We use
</span><span class='d'>;; string-dist for all Tokens.
</span>(<a id='799' tid='800' class='u'>define</a> <a id='801' tid='802' class='u'>*max-string-len*</a> <span class='d'>200</span>)


<span class='d'>;; only memoize the diff of nodes of size larger than this
</span><span class='d'>;; number
</span>(<a id='803' tid='804' class='u'>define</a> <a id='805' tid='806' class='u'>*memo-node-size*</a> <a id='807' tid='808' class='u'>2</a>)



<span class='d'>(define *keywords* &#39;())</span>
<span class='d'>(define *keyword-exchange* &#39;())</span>
<span class='d'>(define *defs* &#39;())</span>



<span class='d'>;-------------------------------------------------------------
</span><span class='d'>;                      utilities
</span><span class='d'>;-------------------------------------------------------------
</span>
(<a id='1551' tid='1552' class='u'>define</a> <a id='1553' tid='1554' class='u'>qs</a>
  <span class='d'>(lambda (x)
    (string-append &quot;&#39;&quot; (number-&gt;string x) &quot;&#39;&quot;))</span>)


(<a id='1403' tid='1404' class='u'>define</a> <a id='1405' tid='1406' class='u'>line</a>
  (<a id='1407' tid='1408' class='u'>lambda</a> (<a id='1409' tid='1410' class='u'>port</a> <a id='1411' tid='1412' class='u'>.</a> <a id='1413' tid='1414' class='u'>s</a>)
    (<a id='1415' tid='1416' class='u'>display</a> (<a id='1417' tid='1418' class='u'>string-append</a> (<a id='1419' tid='1420' class='u'>apply</a> <a id='1421' tid='1422' class='u'>string-append</a> <a id='1423' tid='1424' class='u'>s</a>) <a id='1425' tid='1426' class='u'>&quot;\n&quot;</a>) <a id='1427' tid='1428' class='u'>port</a>)))



<span class='d'>;-------------------------------------------------------------
</span><span class='d'>;                      data types
</span><span class='d'>;-------------------------------------------------------------
</span>
<span class='d'>(struct Change (orig cur cost type) #:transparent)</span>
(<a id='1923' tid='1924' class='u'>struct</a> <a id='1925' tid='1926' class='u'>Tag</a> (<a id='1927' tid='1928' class='u'>tag</a> <a id='1929' tid='1930' class='u'>idx</a> <a id='1931' tid='1932' class='u'>start</a>) <a id='1933' tid='1934' class='u'>#:transparent</a>)


(<a id='1399' tid='1400' class='u'>define</a> <a id='1401' tid='1402' class='u'>ins?</a>
  <span class='d'>(lambda (c)
    (not (Change-orig c)))</span>)

(<a id='1107' tid='1108' class='u'>define</a> <a id='1109' tid='1110' class='u'>del?</a>
  <span class='d'>(lambda (c)
    (not (Change-cur c)))</span>)

(<a id='1535' tid='1536' class='u'>define</a> <a id='1537' tid='1538' class='u'>mod?</a>
  <span class='d'>(lambda (c)
    (and (Change-orig c) (Change-cur c)))</span>)



<a id='1935' tid='1936' class='u'>;----------------- utils for creating changes ----------------
</a>(<a id='1747' tid='1748' class='u'>define</a> <a id='1749' tid='1750' class='u'>total</a>
  (<a id='495' tid='496' class='m'>lambda</a> (<a id='497' tid='498' class='m'>node1</a> <a id='499' tid='500' class='m'>node2</a>)
    (<span class='d'>let</span> ([<a id='501' tid='502' class='m'>size1</a> (<a id='503' tid='504' class='m'>node-size</a> <a id='505' tid='506' class='m'>node1</a>)]
          [<a id='507' tid='508' class='m'>size2</a> (<a id='509' tid='510' class='m'>node-size</a> <a id='511' tid='512' class='m'>node2</a>)])
      <span class='d'>(values (append (del-node node1) (ins-node node2))
              (+ size1 size2))</span>)))

(<span class='d'>define</span> <span class='d'>del-node</span>
  (<a id='389' tid='390' class='m'>lambda</a> (<a id='391' tid='392' class='m'>node</a>)
    (<a id='393' tid='394' class='m'>let</a> ([<a id='395' tid='396' class='m'>size</a> (<a id='397' tid='398' class='m'>node-size</a> <a id='399' tid='400' class='m'>node</a>)])
      (<a id='401' tid='402' class='m'>list</a> (<a id='403' tid='404' class='m'>Change</a> <a id='405' tid='406' class='m'>node</a> <a id='407' tid='408' class='m'>#f</a> <a id='409' tid='410' class='m'>size</a> <a id='411' tid='412' class='m'>&#39;</a><a id='413' tid='414' class='m'>del</a>)))))

(<span class='d'>define</span> <span class='d'>ins-node</span>
  (<a id='425' tid='426' class='m'>lambda</a> (<a id='427' tid='428' class='m'>node</a>)
    (<a id='429' tid='430' class='m'>let</a> ([<a id='431' tid='432' class='m'>size</a> (<a id='433' tid='434' class='m'>node-size</a> <a id='435' tid='436' class='m'>node</a>)])
      (<a id='437' tid='438' class='m'>list</a> (<a id='439' tid='440' class='m'>Change</a> <a id='441' tid='442' class='m'>#f</a> <a id='443' tid='444' class='m'>node</a> <a id='445' tid='446' class='m'>size</a> <a id='447' tid='448' class='m'>&#39;</a><a id='449' tid='450' class='m'>ins</a>)))))



<span class='d'>(define disassemble-frame
  (lambda (node)
    (cond
     [(and (Expr? node) (eq? &#39;frame (Expr-type node)))
      (apply append (map disassemble-frame (Expr-elts node)))]
     [else (list node)])))</span>


<span class='d'>(define disassemble-change
  (lambda (change)
    (cond
     [(ins? change)
      (apply append
             (map ins-node
                  (disassemble-frame (Change-cur change))))]
     [(del? change)
      (apply append
             (map del-node
                  (disassemble-frame (Change-orig change))))]
     [else (list change)])))</span>


(<a id='1371' tid='1372' class='u'>define</a> <a id='1373' tid='1374' class='u'>extract-frame</a>
  (<span class='d'>lambda</span> <span class='d'>(node1 node2)</span>
    (<span class='d'>match</span> <span class='d'>node1</span>
      [<span class='d'>(Expr type1 elts1 start1 end1)</span>
       (<span class='d'>let</span> ([<a id='513' tid='514' class='m'>frame-elts</a> (<a id='515' tid='516' class='m'>filter</a> (<a id='517' tid='518' class='m'>lambda</a> (<a id='519' tid='520' class='m'>x</a>)
                                   (<a id='521' tid='522' class='m'>not</a> (<a id='523' tid='524' class='m'>eq?</a> <a id='525' tid='526' class='m'>x</a> <a id='527' tid='528' class='m'>node2</a>)))
                                 <a id='529' tid='530' class='m'>elts1</a>)])
         <span class='d'>(Expr &#39;frame frame-elts start1 start1)</span>)]
      <span class='d'>[_ fatal &#39;extract-frame &quot;I only accept Expr&quot;]</span>)))



<span class='d'>(define extract-ins-frame
  (lambda (node1 node2)
    (let ([frame (extract-frame node1 node2)])
      (cond
       [(not frame) &#39;()]
       [else
        (ins-node frame)]))))</span>



<span class='d'>(define extract-del-frame
  (lambda (node1 node2)
    (let ([frame (extract-frame node1 node2)])
      (cond
       [(not frame) &#39;()]
       [else
        (del-node frame)]))))</span>



<span class='d'>;; (define n1 (Token &quot;ok&quot; 0 1))
</span>
<span class='d'>;; (define n2 (Expr &#39;ok (list n1 (Token &quot;bar&quot; 1 2)) 0 2))
</span>
<span class='d'>;; (map disassemble-change (extract-ins-frame n2 n1))
</span>



<span class='d'>(define ins-node-except
  (lambda (node1 node2)
    (let ([nodes (map (lambda (x)
                        (if (not (eq? x node2))
                            (ins-node x)
                            &#39;()))
                      (Expr-elts node1))])
      (apply append nodes))))</span>


<span class='d'>(define del-node-except
  (lambda (node1 node2)
    (let ([nodes (map (lambda (x)
                        (if (not (eq? x node2))
                            (del-node x)
                            &#39;()))
                      (Expr-elts node1))])
      (apply append nodes))))</span>



(<span class='d'>define</span> <span class='d'>mod-node</span>
  (<a id='451' tid='452' class='m'>lambda</a> (<a id='453' tid='454' class='m'>node1</a> <a id='455' tid='456' class='m'>node2</a> <a id='457' tid='458' class='m'>cost</a>)
    (<a id='459' tid='460' class='m'>list</a> (<a id='461' tid='462' class='m'>Change</a> <a id='463' tid='464' class='m'>node1</a> <a id='465' tid='466' class='m'>node2</a> <a id='467' tid='468' class='m'>cost</a> <a id='469' tid='470' class='m'>&#39;</a><a id='471' tid='472' class='m'>mod</a>))))

(<span class='d'>define</span> <span class='d'>mov-node</span>
  (<a id='473' tid='474' class='m'>lambda</a> (<a id='475' tid='476' class='m'>node1</a> <a id='477' tid='478' class='m'>node2</a> <a id='479' tid='480' class='m'>cost</a>)
    (<a id='481' tid='482' class='m'>list</a> (<a id='483' tid='484' class='m'>Change</a> <a id='485' tid='486' class='m'>node1</a> <a id='487' tid='488' class='m'>node2</a> <a id='489' tid='490' class='m'>cost</a> <a id='491' tid='492' class='m'>&#39;</a><a id='493' tid='494' class='m'>mov</a>))))

(<a id='1495' tid='1496' class='u'>define</a> <a id='1497' tid='1498' class='u'>mod-&gt;mov</a>
  (<a id='1499' tid='1500' class='u'>lambda</a> (<a id='1501' tid='1502' class='u'>c</a>)
    (<a id='1503' tid='1504' class='u'>match</a> <a id='1505' tid='1506' class='u'>c</a>
     [(<a id='1507' tid='1508' class='u'>Change</a> <a id='1509' tid='1510' class='u'>node1</a> <a id='1511' tid='1512' class='u'>node2</a> <a id='1513' tid='1514' class='u'>cost</a> <a id='1515' tid='1516' class='u'>&#39;</a><a id='1517' tid='1518' class='u'>mod</a>)
      (<a id='1519' tid='1520' class='u'>Change</a> <a id='1521' tid='1522' class='u'>node1</a> <a id='1523' tid='1524' class='u'>node2</a> <a id='1525' tid='1526' class='u'>cost</a> <a id='1527' tid='1528' class='u'>&#39;</a><a id='1529' tid='1530' class='u'>mov</a>)]
     [<a id='1531' tid='1532' class='u'>other</a> <a id='1533' tid='1534' class='u'>other</a>])))




<span class='d'>;------------------ operations on nodes ---------------------
</span>
(<span class='d'>define</span> <span class='d'>node-equal?</span>
  (<span class='d'>lambda</span> <span class='d'>(node1 node2)</span>
    (<span class='d'>cond</span>
     <span class='d'>[(and (null? node1) (null? node2)) #t]</span>
     <span class='d'>[(and (Str? node1) (Str? node2))
      (and (equal? (Str-s node1) (Str-s node2)))]</span>
     <span class='d'>[(and (Comment? node1) (Comment? node2))
      (and (equal? (Comment-text node1) (Comment-text node2)))]</span>
     <span class='d'>[(and (Char? node1) (Char? node2))
      (and (equal? (Char-c node1) (Char-c node2)))]</span>
     <span class='d'>[(and (Token? node1) (Token? node2))
      (and (equal? (Token-text node1)
                   (Token-text node2)))]</span>
     <span class='d'>[(and (Expr? node1) (Expr? node2))
      (and (eq? (Expr-type node1)
                (Expr-type node2))
           (node-equal? (Expr-elts node1)
                        (Expr-elts node2)))]</span>
     [(<a id='81' tid='82' class='m'>and</a> (<a id='83' tid='84' class='m'>pair?</a> <a id='85' tid='86' class='m'>node1</a>) (<a id='87' tid='88' class='m'>pair?</a> <a id='89' tid='90' class='m'>node2</a>))
      <span class='d'>(and (node-equal? (car node1) (car node2))
           (node-equal? (cdr node1) (cdr node2)))</span>]
     <span class='d'>[else #f]</span>)))



<span class='d'>(define keyword-exchangeable?
  (lambda (k1 k2)
    (cond
     [(eq? k1 k2) #t]
     [(assq k1 *keyword-exchange*)
      =&gt; (lambda (p)
           (cond
            [(memq k2 (cdr p)) #t]
            [else #f]))]
     [else #f])))</span>



<span class='d'>(define keywords-equal?
  (lambda (node1 node2)
    (and (eq? (Expr-type node1)
              (Expr-type node2))
         (not (keywords-differ? node1 node2)))))</span>



<span class='d'>(define keywords-differ?
  (lambda (exp1 exp2)
    (let ([key1 (and (not (null? (Expr-elts exp1)))
                     (get-symbol (car (Expr-elts exp1))))]
          [key2 (and (not (null? (Expr-elts exp2)))
                     (get-symbol (car (Expr-elts exp2))))])
      (cond
       [(and key1 key2
             (or (memq key1 *keywords*)
                 (memq key2 *keywords*))
             (not (keyword-exchangeable? key1 key2)))
        #t]
       [else #f]))))</span>



<span class='d'>(define get-symbol
  (lambda (node)
    (cond
     [(Token? node)
      (string-&gt;symbol (Token-text node))]
     [else #f])))</span>



(<a id='1555' tid='1556' class='u'>define</a> <a id='1557' tid='1558' class='u'>same-def?</a>
  <span class='d'>(lambda (e1 e2)
    (cond
      [(and (Expr? e1) (Expr? e2))
       (let ([elts1 (Expr-elts e1)]
             [elts2 (Expr-elts e2)])
         (cond
          [(and (&gt; (length elts1) 1)
                (&gt; (length elts2) 1)
                (memq (get-symbol (car elts1)) *defs*)
                (memq (get-symbol (car elts2)) *defs*))
           (eq? (get-symbol (cadr elts1))
                (get-symbol (cadr elts2)))]
          [else #f]))]
      [else #f]))</span>)

<span class='d'>;; (same-def? (car (parse-scheme &quot;(define f 1)&quot;))
</span><span class='d'>;;            (car (parse-scheme &quot;(define g 1)&quot;)))
</span>


<span class='d'>(define different-def?
  (lambda (e1 e2)
    (cond
      [(and (Expr? e1) (Expr? e2))
       (let ([elts1 (Expr-elts e1)]
             [elts2 (Expr-elts e2)])
         (cond
          [(and (&gt; (length elts1) 1)
                (&gt; (length elts2) 1)
                (memq (get-symbol (car elts1)) *defs*)
                (memq (get-symbol (car elts2)) *defs*))
           (not (eq? (get-symbol (cadr elts1))
                     (get-symbol (cadr elts2))))]
          [else #f]))]
      [else #f])))</span>

<span class='d'>;; (different-def? (car (parse-scheme &quot;(define f 1)&quot;))
</span><span class='d'>;;                 (car (parse-scheme &quot;(let f 1)&quot;)))
</span>


<span class='d'>;; whether two nodes are similar given the cost
</span><span class='d'>(define similar?
  (lambda (node1 node2 c)
    (&lt;= c (* *move-ratio* (+ (node-size node1)
                             (node-size node2))))))</span>


(<a id='815' tid='816' class='u'>define</a> <a id='817' tid='818' class='u'>*node-size-hash*</a> (<a id='819' tid='820' class='u'>make-hasheq</a>))

(<a id='1543' tid='1544' class='u'>define</a> <a id='1545' tid='1546' class='u'>node-size</a>
  (<a id='559' tid='560' class='m'>lambda</a> (<a id='561' tid='562' class='m'>node</a>)
    (<a id='531' tid='532' class='m'>define</a> <a id='533' tid='534' class='m'>memo</a>
      (<a id='535' tid='536' class='m'>lambda</a> (<a id='537' tid='538' class='m'>v</a>)
        (<a id='539' tid='540' class='m'>if</a> (<a id='541' tid='542' class='m'>&gt;</a> <a id='543' tid='544' class='m'>v</a> <a id='545' tid='546' class='m'>1</a>)
            (<a id='547' tid='548' class='m'>hash-set!</a> <a id='549' tid='550' class='m'>*node-size-hash*</a> <a id='551' tid='552' class='m'>node</a> <a id='553' tid='554' class='m'>v</a>)
            (<a id='555' tid='556' class='m'>void</a>))
        <a id='557' tid='558' class='m'>v</a>))
    (<span class='d'>cond</span>
     [(<a id='563' tid='564' class='m'>pair?</a> <a id='565' tid='566' class='m'>node</a>)
      (<a id='567' tid='568' class='m'>apply</a> <a id='569' tid='570' class='m'>+</a> (<a id='571' tid='572' class='m'>map</a> <a id='573' tid='574' class='m'>node-size</a> <a id='575' tid='576' class='m'>node</a>))]
     <span class='d'>[(or (Token? node) (Str? node) (Char? node)) 1]</span>
     [<span class='d'>(Expr? node)</span>
      (<span class='d'>cond</span>
       [(<a id='165' tid='166' class='m'>hash-has-key?</a> <a id='167' tid='168' class='m'>*node-size-hash*</a> <a id='169' tid='170' class='m'>node</a>)
        (<a id='171' tid='172' class='m'>hash-ref</a> <a id='173' tid='174' class='m'>*node-size-hash*</a> <a id='175' tid='176' class='m'>node</a>)]
       <span class='d'>[else
        (memo (node-size (Expr-elts node)))]</span>)]
     <span class='d'>[else 0]</span>)))


(<a id='1539' tid='1540' class='u'>define</a> <a id='1541' tid='1542' class='u'>node-depth</a>
  (<a id='577' tid='578' class='m'>lambda</a> (<a id='579' tid='580' class='m'>node</a>)
    (<span class='d'>cond</span>
     <span class='d'>[(null? node) 0]</span>
     [(<a id='581' tid='582' class='m'>pair?</a> <a id='583' tid='584' class='m'>node</a>)
      (<a id='585' tid='586' class='m'>apply</a> <a id='587' tid='588' class='m'>max</a> (<a id='589' tid='590' class='m'>map</a> <a id='591' tid='592' class='m'>node-depth</a> <a id='593' tid='594' class='m'>node</a>))]
     <span class='d'>[(Expr? node)
      (add1 (node-depth (Expr-elts node)))]</span>
     <span class='d'>[else 0]</span>)))


<span class='d'>; (node-depth (parse-scheme &quot;(lambda (x (x (y)) (y)) x)&quot;))
</span>
<span class='d'>;; (same-def? (parse-scheme &quot;(define f (x 1))&quot;)
</span><span class='d'>;;            (parse-scheme &quot;(define f 2&quot;))
</span>


(<a id='1751' tid='1752' class='u'>define</a> <a id='1753' tid='1754' class='u'>uid</a>
  (<a id='1755' tid='1756' class='u'>let</a> ([<a id='1757' tid='1758' class='u'>count</a> <a id='1759' tid='1760' class='u'>1</a>]
        [<a id='1761' tid='1762' class='u'>table</a> (<a id='1763' tid='1764' class='u'>box</a> <a id='1765' tid='1766' class='u'>&#39;</a>())])
    (<a id='1767' tid='1768' class='u'>lambda</a> (<a id='1769' tid='1770' class='u'>node</a>)
      (<a id='1771' tid='1772' class='u'>let</a> ([<a id='1773' tid='1774' class='u'>p</a> (<a id='1775' tid='1776' class='u'>assq</a> <a id='1777' tid='1778' class='u'>node</a> (<a id='1779' tid='1780' class='u'>unbox</a> <a id='1781' tid='1782' class='u'>table</a>))])
        (<a id='1783' tid='1784' class='u'>cond</a>
         [(<a id='1785' tid='1786' class='u'>not</a> <a id='1787' tid='1788' class='u'>p</a>)
          (<a id='1789' tid='1790' class='u'>let</a> ([<a id='1791' tid='1792' class='u'>id</a> <a id='1793' tid='1794' class='u'>count</a>])
            (<a id='1795' tid='1796' class='u'>set!</a> <a id='1797' tid='1798' class='u'>count</a> (<a id='1799' tid='1800' class='u'>add1</a> <a id='1801' tid='1802' class='u'>count</a>))
            (<a id='1803' tid='1804' class='u'>set-box!</a> <a id='1805' tid='1806' class='u'>table</a> (<a id='1807' tid='1808' class='u'>cons</a> <a id='1809' tid='1810' class='u'>`</a>(<a id='1811' tid='1812' class='u'>,</a><a id='1813' tid='1814' class='u'>node</a> <a id='1815' tid='1816' class='u'>.</a> <a id='1817' tid='1818' class='u'>,</a><a id='1819' tid='1820' class='u'>id</a>) (<a id='1821' tid='1822' class='u'>unbox</a> <a id='1823' tid='1824' class='u'>table</a>)))
            <a id='1825' tid='1826' class='u'>id</a>)]
         [<a id='1827' tid='1828' class='u'>else</a>
          (<a id='1829' tid='1830' class='u'>cdr</a> <a id='1831' tid='1832' class='u'>p</a>)])))))



(<a id='1559' tid='1560' class='u'>define</a> <a id='1561' tid='1562' class='u'>similarity</a>
  (<a id='595' tid='596' class='m'>lambda</a> (<a id='597' tid='598' class='m'>change</a>)
    (<span class='d'>let</span> <span class='d'>([total (+ (node-size (Change-orig change))
                    (node-size (Change-cur change)))])</span>
      (<a id='599' tid='600' class='m'>cond</a>
       [(<a id='601' tid='602' class='m'>or</a> (<a id='603' tid='604' class='m'>=</a> <a id='605' tid='606' class='m'>0</a> <a id='607' tid='608' class='m'>total</a>) (<a id='609' tid='610' class='m'>=</a> <a id='611' tid='612' class='m'>0</a> (<a id='613' tid='614' class='m'>Change-cost</a> <a id='615' tid='616' class='m'>change</a>)))
        <a id='617' tid='618' class='m'>&quot;100%&quot;</a>]
       [<a id='619' tid='620' class='m'>else</a>
        (<a id='621' tid='622' class='m'>string-append</a>
         (<a id='623' tid='624' class='m'>real-&gt;decimal-string</a>
          (<a id='625' tid='626' class='m'>*</a> <a id='627' tid='628' class='m'>100</a> (<a id='629' tid='630' class='m'>-</a> <a id='631' tid='632' class='m'>1.0</a> (<a id='633' tid='634' class='m'>/</a> (<a id='635' tid='636' class='m'>Change-cost</a> <a id='637' tid='638' class='m'>change</a>) <a id='639' tid='640' class='m'>total</a>))) <a id='641' tid='642' class='m'>1</a>)
         <a id='643' tid='644' class='m'>&quot;%&quot;</a>)]))))



<span class='d'>;-------------------------------------------------------------
</span><span class='d'>;                        diff stuff
</span><span class='d'>;-------------------------------------------------------------
</span>
<span class='d'>; 2-D memoization table
</span>(<a id='1433' tid='1434' class='u'>define</a> <a id='1435' tid='1436' class='u'>make-table</a>
  (<a id='1437' tid='1438' class='u'>lambda</a> (<a id='1439' tid='1440' class='u'>dim1</a> <a id='1441' tid='1442' class='u'>dim2</a>)
    (<a id='1443' tid='1444' class='u'>let</a> ([<a id='1445' tid='1446' class='u'>vec</a> (<a id='1447' tid='1448' class='u'>make-vector</a> (<a id='1449' tid='1450' class='u'>add1</a> <a id='1451' tid='1452' class='u'>dim1</a>))])
      (<a id='1453' tid='1454' class='u'>let</a> <a id='1455' tid='1456' class='u'>loop</a> ([<a id='1457' tid='1458' class='u'>n</a> <a id='1459' tid='1460' class='u'>0</a>])
        (<a id='1461' tid='1462' class='u'>cond</a>
         [(<a id='1463' tid='1464' class='u'>=</a> <a id='1465' tid='1466' class='u'>n</a> (<a id='1467' tid='1468' class='u'>vector-length</a> <a id='1469' tid='1470' class='u'>vec</a>)) <a id='1471' tid='1472' class='u'>vec</a>]
         [<a id='1473' tid='1474' class='u'>else</a>
          (<a id='1475' tid='1476' class='u'>vector-set!</a> <a id='1477' tid='1478' class='u'>vec</a> <a id='1479' tid='1480' class='u'>n</a> (<a id='1481' tid='1482' class='u'>make-vector</a> (<a id='1483' tid='1484' class='u'>add1</a> <a id='1485' tid='1486' class='u'>dim2</a>) <a id='1487' tid='1488' class='u'>#f</a>))
          (<a id='1489' tid='1490' class='u'>loop</a> (<a id='1491' tid='1492' class='u'>add1</a> <a id='1493' tid='1494' class='u'>n</a>))])))))


(<a id='1643' tid='1644' class='u'>define</a> <a id='1645' tid='1646' class='u'>table-ref</a>
  (<a id='1647' tid='1648' class='u'>lambda</a> (<a id='1649' tid='1650' class='u'>t</a> <a id='1651' tid='1652' class='u'>x</a> <a id='1653' tid='1654' class='u'>y</a>)
    (<a id='1655' tid='1656' class='u'>let</a> ([<a id='1657' tid='1658' class='u'>row</a> (<a id='1659' tid='1660' class='u'>vector-ref</a> <a id='1661' tid='1662' class='u'>t</a> <a id='1663' tid='1664' class='u'>x</a>)])
      (<a id='1665' tid='1666' class='u'>vector-ref</a> <a id='1667' tid='1668' class='u'>row</a> <a id='1669' tid='1670' class='u'>y</a>))))


(<a id='1671' tid='1672' class='u'>define</a> <a id='1673' tid='1674' class='u'>table-set!</a>
  (<a id='1675' tid='1676' class='u'>lambda</a> (<a id='1677' tid='1678' class='u'>t</a> <a id='1679' tid='1680' class='u'>x</a> <a id='1681' tid='1682' class='u'>y</a> <a id='1683' tid='1684' class='u'>v</a>)
    (<a id='1685' tid='1686' class='u'>let</a> ([<a id='1687' tid='1688' class='u'>row</a> (<a id='1689' tid='1690' class='u'>vector-ref</a> <a id='1691' tid='1692' class='u'>t</a> <a id='1693' tid='1694' class='u'>x</a>)])
      (<a id='1695' tid='1696' class='u'>vector-set!</a> <a id='1697' tid='1698' class='u'>row</a> <a id='1699' tid='1700' class='u'>y</a> <a id='1701' tid='1702' class='u'>v</a>))))



<span class='d'>;---------------- string distance function -----------------
</span>
(<a id='1567' tid='1568' class='u'>define</a> <a id='1569' tid='1570' class='u'>string-dist</a>
  (<a id='1571' tid='1572' class='u'>lambda</a> (<a id='1573' tid='1574' class='u'>s1</a> <a id='1575' tid='1576' class='u'>s2</a>)
    (<a id='1577' tid='1578' class='u'>let*</a> ([<a id='1579' tid='1580' class='u'>len1</a> (<a id='1581' tid='1582' class='u'>string-length</a> <a id='1583' tid='1584' class='u'>s1</a>)]
           [<a id='1585' tid='1586' class='u'>len2</a> (<a id='1587' tid='1588' class='u'>string-length</a> <a id='1589' tid='1590' class='u'>s2</a>)]
           [<a id='1591' tid='1592' class='u'>t</a> (<a id='1593' tid='1594' class='u'>make-table</a> <a id='1595' tid='1596' class='u'>len1</a> <a id='1597' tid='1598' class='u'>len2</a>)]
           [<a id='1599' tid='1600' class='u'>char-dist</a> (<a id='1601' tid='1602' class='u'>dist1</a> <a id='1603' tid='1604' class='u'>t</a> <a id='1605' tid='1606' class='u'>s1</a> <a id='1607' tid='1608' class='u'>0</a> <a id='1609' tid='1610' class='u'>s2</a> <a id='1611' tid='1612' class='u'>0</a>)])
      (<a id='1613' tid='1614' class='u'>cond</a>
       [(<a id='1615' tid='1616' class='u'>=</a> <a id='1617' tid='1618' class='u'>0</a> (<a id='1619' tid='1620' class='u'>+</a> <a id='1621' tid='1622' class='u'>len1</a> <a id='1623' tid='1624' class='u'>len2</a>)) <a id='1625' tid='1626' class='u'>0</a>]
       [<a id='1627' tid='1628' class='u'>else</a>
        (<a id='1629' tid='1630' class='u'>/</a> (<a id='1631' tid='1632' class='u'>*</a> <a id='1633' tid='1634' class='u'>2.0</a> <a id='1635' tid='1636' class='u'>char-dist</a>) (<a id='1637' tid='1638' class='u'>+</a> <a id='1639' tid='1640' class='u'>len1</a> <a id='1641' tid='1642' class='u'>len2</a>))]))))



(<a id='1135' tid='1136' class='u'>define</a> <a id='1137' tid='1138' class='u'>dist1</a>
  (<a id='1159' tid='1160' class='u'>lambda</a> (<a id='1161' tid='1162' class='u'>table</a> <a id='1163' tid='1164' class='u'>s1</a> <a id='1165' tid='1166' class='u'>start1</a> <a id='1167' tid='1168' class='u'>s2</a> <a id='1169' tid='1170' class='u'>start2</a>)
    (<a id='1139' tid='1140' class='u'>define</a> <a id='1141' tid='1142' class='u'>memo</a>
      (<a id='1143' tid='1144' class='u'>lambda</a> (<a id='1145' tid='1146' class='u'>value</a>)
        (<a id='1147' tid='1148' class='u'>table-set!</a> <a id='1149' tid='1150' class='u'>table</a> <a id='1151' tid='1152' class='u'>start1</a> <a id='1153' tid='1154' class='u'>start2</a> <a id='1155' tid='1156' class='u'>value</a>)
        <a id='1157' tid='1158' class='u'>value</a>))
    (<a id='1171' tid='1172' class='u'>cond</a>
     [(<a id='1173' tid='1174' class='u'>table-ref</a> <a id='1175' tid='1176' class='u'>table</a> <a id='1177' tid='1178' class='u'>start1</a> <a id='1179' tid='1180' class='u'>start2</a>)
      <a id='1181' tid='1182' class='u'>=&gt;</a> (<a id='1183' tid='1184' class='u'>lambda</a> (<a id='1185' tid='1186' class='u'>cached</a>) <a id='1187' tid='1188' class='u'>cached</a>)]
     [(<a id='1189' tid='1190' class='u'>=</a> <a id='1191' tid='1192' class='u'>start1</a> (<a id='1193' tid='1194' class='u'>string-length</a> <a id='1195' tid='1196' class='u'>s1</a>))
      (<a id='1197' tid='1198' class='u'>memo</a> (<a id='1199' tid='1200' class='u'>-</a> (<a id='1201' tid='1202' class='u'>string-length</a> <a id='1203' tid='1204' class='u'>s2</a>) <a id='1205' tid='1206' class='u'>start2</a>))]
     [(<a id='1207' tid='1208' class='u'>=</a> <a id='1209' tid='1210' class='u'>start2</a> (<a id='1211' tid='1212' class='u'>string-length</a> <a id='1213' tid='1214' class='u'>s2</a>))
      (<a id='1215' tid='1216' class='u'>memo</a> (<a id='1217' tid='1218' class='u'>-</a> (<a id='1219' tid='1220' class='u'>string-length</a> <a id='1221' tid='1222' class='u'>s1</a>) <a id='1223' tid='1224' class='u'>start1</a>))]
     [<a id='1225' tid='1226' class='u'>else</a>
      (<a id='1227' tid='1228' class='u'>let*</a> ([<a id='1229' tid='1230' class='u'>c1</a> (<a id='1231' tid='1232' class='u'>string-ref</a> <a id='1233' tid='1234' class='u'>s1</a> <a id='1235' tid='1236' class='u'>start1</a>)]
             [<a id='1237' tid='1238' class='u'>c2</a> (<a id='1239' tid='1240' class='u'>string-ref</a> <a id='1241' tid='1242' class='u'>s2</a> <a id='1243' tid='1244' class='u'>start2</a>)]
             [<a id='1245' tid='1246' class='u'>d0</a> (<a id='1247' tid='1248' class='u'>cond</a>
                  [(<a id='1249' tid='1250' class='u'>char=?</a> <a id='1251' tid='1252' class='u'>c1</a> <a id='1253' tid='1254' class='u'>c2</a>) <a id='1255' tid='1256' class='u'>0</a>]
                  [(<a id='1257' tid='1258' class='u'>char=?</a> (<a id='1259' tid='1260' class='u'>char-downcase</a> <a id='1261' tid='1262' class='u'>c1</a>)
                           (<a id='1263' tid='1264' class='u'>char-downcase</a> <a id='1265' tid='1266' class='u'>c2</a>)) <a id='1267' tid='1268' class='u'>1</a>]
                  [<a id='1269' tid='1270' class='u'>else</a> <a id='1271' tid='1272' class='u'>2</a>])]
             [<a id='1273' tid='1274' class='u'>d1</a> (<a id='1275' tid='1276' class='u'>+</a> <a id='1277' tid='1278' class='u'>d0</a> (<a id='1279' tid='1280' class='u'>dist1</a> <a id='1281' tid='1282' class='u'>table</a> <a id='1283' tid='1284' class='u'>s1</a> (<a id='1285' tid='1286' class='u'>add1</a> <a id='1287' tid='1288' class='u'>start1</a>) <a id='1289' tid='1290' class='u'>s2</a> (<a id='1291' tid='1292' class='u'>add1</a> <a id='1293' tid='1294' class='u'>start2</a>)))]
             [<a id='1295' tid='1296' class='u'>d2</a> (<a id='1297' tid='1298' class='u'>+</a> <a id='1299' tid='1300' class='u'>1</a> (<a id='1301' tid='1302' class='u'>dist1</a> <a id='1303' tid='1304' class='u'>table</a> <a id='1305' tid='1306' class='u'>s1</a> (<a id='1307' tid='1308' class='u'>add1</a> <a id='1309' tid='1310' class='u'>start1</a>) <a id='1311' tid='1312' class='u'>s2</a> <a id='1313' tid='1314' class='u'>start2</a>))]
             [<a id='1315' tid='1316' class='u'>d3</a> (<a id='1317' tid='1318' class='u'>+</a> <a id='1319' tid='1320' class='u'>1</a> (<a id='1321' tid='1322' class='u'>dist1</a> <a id='1323' tid='1324' class='u'>table</a> <a id='1325' tid='1326' class='u'>s1</a> <a id='1327' tid='1328' class='u'>start1</a> <a id='1329' tid='1330' class='u'>s2</a> (<a id='1331' tid='1332' class='u'>add1</a> <a id='1333' tid='1334' class='u'>start2</a>)))])
        (<a id='1335' tid='1336' class='u'>memo</a> (<a id='1337' tid='1338' class='u'>min</a> <a id='1339' tid='1340' class='u'>d1</a> <a id='1341' tid='1342' class='u'>d2</a> <a id='1343' tid='1344' class='u'>d3</a>)))])))



(<a id='1131' tid='1132' class='u'>define</a> <a id='1133' tid='1134' class='u'>diff-string</a>
  (<a id='91' tid='92' class='m'>lambda</a> (<a id='93' tid='94' class='m'>string1</a> <a id='95' tid='96' class='m'>string2</a> <a id='97' tid='98' class='m'>node1</a> <a id='99' tid='100' class='m'>node2</a>)
    (<span class='d'>cond</span>
     [(<a id='101' tid='102' class='m'>or</a> (<a id='103' tid='104' class='m'>&gt;</a> (<a id='105' tid='106' class='m'>string-length</a> <a id='107' tid='108' class='m'>string1</a>) <a id='109' tid='110' class='m'>*max-string-len*</a>)
          (<a id='111' tid='112' class='m'>&gt;</a> (<a id='113' tid='114' class='m'>string-length</a> <a id='115' tid='116' class='m'>string2</a>) <a id='117' tid='118' class='m'>*max-string-len*</a>))
      <span class='d'>(cond
       [(equal? string1 string2)
        (values (mod-node node1 node2 0) 0)]
       [else
        (total node1 node2)])</span>]
     <span class='d'>[else
      (let ([cost (string-dist string1 string2)])
        (values (mod-node node1 node2 cost) cost))]</span>)))




<span class='d'>;--------------------- main node diff function ----------------------
</span>(<a id='1119' tid='1120' class='u'>define</a> <a id='1121' tid='1122' class='u'>diff-node</a>
  (<span class='d'>lambda</span> <span class='d'>(node1 node2 depth move?)</span>

    (<a id='645' tid='646' class='m'>define</a> <a id='647' tid='648' class='m'>memo</a>
      (<a id='649' tid='650' class='m'>lambda</a> (<a id='651' tid='652' class='m'>v1</a> <a id='653' tid='654' class='m'>v2</a>)
        (<span class='d'>if</span> (<a id='199' tid='200' class='m'>and</a> (<a id='201' tid='202' class='m'>&gt;</a> (<a id='203' tid='204' class='m'>node-size</a> <a id='205' tid='206' class='m'>node1</a>) <a id='207' tid='208' class='m'>*memo-node-size*</a>)
                 (<a id='209' tid='210' class='m'>&gt;</a> (<a id='211' tid='212' class='m'>node-size</a> <a id='213' tid='214' class='m'>node2</a>) <a id='215' tid='216' class='m'>*memo-node-size*</a>))
            (<a id='655' tid='656' class='m'>hash-put!</a> <a id='657' tid='658' class='m'>*diff-hash*</a> <a id='659' tid='660' class='m'>node1</a> <a id='661' tid='662' class='m'>node2</a> (<a id='663' tid='664' class='m'>cons</a> <a id='665' tid='666' class='m'>v1</a> <a id='667' tid='668' class='m'>v2</a>))
            <span class='d'>(void)</span>)
        (<a id='669' tid='670' class='m'>values</a> <a id='671' tid='672' class='m'>v1</a> <a id='673' tid='674' class='m'>v2</a>)))

    (<span class='d'>define</span> <span class='d'>trysub</span>
      (<span class='d'>lambda</span> <span class='d'>(changes cost)</span>
        (<span class='d'>cond</span>
         <span class='d'>[(or (not move?)
              (similar? node1 node2 cost))
          (memo changes cost)]</span>
         [<a id='177' tid='178' class='m'>else</a>
          (<span class='d'>letv</span> <span class='d'>([(m c) (diff-sub node1 node2 depth move?)])</span>
            (<a id='179' tid='180' class='m'>cond</a>
             [(<a id='181' tid='182' class='m'>not</a> <a id='183' tid='184' class='m'>m</a>)
              (<a id='185' tid='186' class='m'>memo</a> <a id='187' tid='188' class='m'>changes</a> <a id='189' tid='190' class='m'>cost</a>)]
             [<a id='191' tid='192' class='m'>else</a>
              (<a id='193' tid='194' class='m'>memo</a> <a id='195' tid='196' class='m'>m</a> <a id='197' tid='198' class='m'>c</a>)]))])))

    <span class='d'>(diff-progress 1)</span>

    (<span class='d'>cond</span>
     [(<a id='229' tid='230' class='m'>hash-get</a> <a id='231' tid='232' class='m'>*diff-hash*</a> <a id='233' tid='234' class='m'>node1</a> <a id='235' tid='236' class='m'>node2</a>)
      <a id='237' tid='238' class='m'>=&gt;</a> (<a id='319' tid='320' class='m'>lambda</a> (<a id='321' tid='322' class='m'>cached</a>)
           (<a id='323' tid='324' class='m'>values</a> (<a id='325' tid='326' class='m'>car</a> <a id='327' tid='328' class='m'>cached</a>) (<a id='329' tid='330' class='m'>cdr</a> <a id='331' tid='332' class='m'>cached</a>)))]
     <span class='d'>[(and (Char? node1) (Char? node2))
      (diff-string (char-&gt;string (Char-c node1))
                   (char-&gt;string (Char-c node2))
                   node1 node2)]</span>
     <span class='d'>[(and (Str? node1) (Str? node2))
      (diff-string (Str-s node1) (Str-s node2) node1 node2)]</span>
     <span class='d'>[(and (Comment? node1) (Comment? node2))
      (diff-string (Comment-text node1) (Comment-text node2) node1 node2)]</span>
     <span class='d'>[(and (Token? node1) (Token? node2))
      (diff-string (Token-text node1) (Token-text node2) node1 node2)]</span>
     <span class='d'>[(and (Expr? node1) (Expr? node2)
           (keywords-equal? node1 node2))
      (letv ([t (make-hasheq)]
             [(m c) (diff-list t (Expr-elts node1) (Expr-elts node2)
                               depth move?)])
        (trysub m c))]</span>
     [(<a id='217' tid='218' class='m'>and</a> (<a id='219' tid='220' class='m'>pair?</a> <a id='221' tid='222' class='m'>node1</a>) (<a id='223' tid='224' class='m'>not</a> (<a id='225' tid='226' class='m'>pair?</a> <a id='227' tid='228' class='m'>node2</a>)))
      <span class='d'>(let ([t (make-hasheq)])
        (diff-list t node1 (list node2) depth move?))</span>]
     [(<a id='57' tid='58' class='m'>and</a> (<a id='59' tid='60' class='m'>not</a> (<a id='61' tid='62' class='m'>pair?</a> <a id='63' tid='64' class='m'>node1</a>)) (<a id='65' tid='66' class='m'>pair?</a> <a id='67' tid='68' class='m'>node2</a>))
      <span class='d'>(let ([t (make-hasheq)])
        (diff-list t (list node1) node2 depth move?))</span>]
     <span class='d'>[(and (pair? node1) (pair? node2))
      (let ([t (make-hasheq)])
        (diff-list t node1 node2 depth move?))]</span>
     [<a id='1' tid='2' class='m'>else</a>
      (<span class='d'>letv</span> ([(<a id='3' tid='4' class='m'>m</a> <a id='5' tid='6' class='m'>c</a>) (<a id='7' tid='8' class='m'>total</a> <a id='9' tid='10' class='m'>node1</a> <a id='11' tid='12' class='m'>node2</a>)])
        <span class='d'>(trysub m c)</span>)])))






<span class='d'>;; global 2D hash for storing known diffs
</span>(<a id='763' tid='764' class='u'>define</a> <a id='765' tid='766' class='u'>*diff-hash*</a> (<a id='767' tid='768' class='u'>make-hasheq</a>))

(<a id='1115' tid='1116' class='u'>define</a> <a id='1117' tid='1118' class='u'>diff-list</a>
  (<span class='d'>lambda</span> <span class='d'>(table ls1 ls2 depth move?)</span>

    (<a id='239' tid='240' class='m'>define</a> <a id='241' tid='242' class='m'>memo</a>
      (<a id='243' tid='244' class='m'>lambda</a> (<a id='245' tid='246' class='m'>v1</a> <a id='247' tid='248' class='m'>v2</a>)
        (<a id='249' tid='250' class='m'>hash-put!</a> <a id='251' tid='252' class='m'>table</a> <a id='253' tid='254' class='m'>ls1</a> <a id='255' tid='256' class='m'>ls2</a> (<a id='257' tid='258' class='m'>cons</a> <a id='259' tid='260' class='m'>v1</a> <a id='261' tid='262' class='m'>v2</a>))
        (<a id='263' tid='264' class='m'>values</a> <a id='265' tid='266' class='m'>v1</a> <a id='267' tid='268' class='m'>v2</a>)))

    (<span class='d'>define</span> <span class='d'>guess</span>
      (<span class='d'>lambda</span> <span class='d'>(ls1  ls2)</span>
        (<span class='d'>letv</span> <span class='d'>([(m0 c0) (diff-node (car ls1) (car ls2) depth move?)]
               [(m1 c1) (diff-list table (cdr ls1) (cdr ls2) depth move?)]
               [(cost1) (+ c0 c1)])</span>
          (<a id='119' tid='120' class='m'>cond</a>
           [(<span class='d'>or</span> (<a id='121' tid='122' class='m'>same-def?</a> (<a id='123' tid='124' class='m'>car</a> <a id='125' tid='126' class='m'>ls1</a>) (<a id='127' tid='128' class='m'>car</a> <a id='129' tid='130' class='m'>ls2</a>))
                <span class='d'>(and (not (different-def? (car ls1) (car ls2)))
                     (similar? (car ls1) (car ls2) c0))</span>)
            (<a id='131' tid='132' class='m'>memo</a> (<a id='133' tid='134' class='m'>append</a> <a id='135' tid='136' class='m'>m0</a> <a id='137' tid='138' class='m'>m1</a>) <a id='139' tid='140' class='m'>cost1</a>)]
           [<a id='141' tid='142' class='m'>else</a>
            (<span class='d'>letv</span> (<span class='d'>[(m2 c2) (diff-list table (cdr ls1) ls2  depth move?)]</span>
                   <span class='d'>[(m3 c3) (diff-list table ls1 (cdr ls2) depth move?)]</span>
                   [<a id='143' tid='144' class='m'>cost2</a> (<a id='145' tid='146' class='m'